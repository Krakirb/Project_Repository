{% extends 'layout.html' %} {% block content %}

<div class="hero-info">
  <h1>{{ listing.Title or listing.Title }}</h1>
  
    {% if average_rating is not none %}
    <div class="rating-circles">
    {% for i in range(1, 6) %}
      {% if average_rating >= i %}
        <div class="circle full"></div>
      {% elif average_rating + 0.5 >= i %}
        <div class="circle half"></div>
      {% else %}
        <div class="circle empty"></div>
      {% endif %}
    {% endfor %}
    <span class="rating-text">{{ average_rating | round(1) }}/5</span>
    <span class="rating-text">({{ rating_count }} reviews)</span>
    {% endif %}
  </div>

  <p class="location">{{ listing.Location }}</p>
  <p class="price">${{ listing.Price }}</p>
  <p class="opening-hours">Opening Hours: {{ listing.Opening_Hours }}</p>
  <p class="description">{{ listing.Description }}</p>
</div>
<div class="gallery">
  {% for url in images %}
  <div class="gallery-item">
    <img src="{{ url }}" alt="Photo of {{ listing.Title }} #{{ loop.index }}" />
  </div>
  {% endfor %}
</div>

<div class="listing-post-section">
<div class="post-container">
  {# listing.html, inside hero-info or near posts #}
  <div>
    <a class="btn btn-primary" href="{{ url_for('add_review', listing_id=listing['Listings_ID'])}}">
      Write a review
    </a>
  </div>

  {% for row in posts %}
    <div class="post-card">
      <div class="rating">
      {% for i in range(1, 6) %}
          {% if i <= row['Post_Rating'] %}
            <span class="rating-circle filled"></span>
          {% else %}
            <span class="rating-circle"></span>
          {% endif %}
        {% endfor %}
      </div>
      <p class="post-card-username">{{ row[''] }}</p>
      <p class="post-card-date">{{ row['Date'] }}</p>
      <p class="post-card-text">{{ row['Text'] }}</p>
      <div class="post-actions">
      <button type="button"
              class="like-btn"
              data-review-id="{{ row['Post_ID'] }}"
              aria-pressed="{{ 'true' if (row['LikedByCurrentUser'] > 0) else 'false' }}"
              title="Like review">
        <svg width="32px" height="32px" viewBox="0 0 32 32" id="icon" xmlns="http://www.w3.org/2000/svg">
        <defs><style>.cls-1 {fill: none;}</style></defs>
        <path d="M26,12H20V6a3.0033,3.0033,0,0,0-3-3H14.8672a2.0094,2.0094,0,0,0-1.98,1.7173l-.8453,5.9165L8.4648,16H2V30H23a7.0078,7.0078,0,0,0,7-7V16A4.0045,4.0045,0,0,0,26,12ZM8,28H4V18H8Zm20-5a5.0057,5.0057,0,0,1-5,5H10V17.3027l3.9578-5.9365L14.8672,5H17a1.0008,1.0008,0,0,1,1,1v8h8a2.0025,2.0025,0,0,1,2,2Z" transform="translate(0 0)"/>
        <rect id="_Transparent_Rectangle_" data-name="&lt;Transparent Rectangle&gt;" class="cls-1" width="32" height="32"/>
        </svg>
        <span class="like-count">{{ row['Likes_Count'] or 0 }}</span>
    </button>
  </div>
    </div>
  {% endfor %}
</div>
<div id="map" class="map-container"></div>
<script>
  var map = L.map('map').setView([{{ listing.Latitude }}, {{ listing.Longitude }}], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  L.marker([{{ listing.Latitude }}, {{ listing.Longitude }}]).addTo(map)
    .bindPopup('{{ listing.Title }}');

  document.addEventListener('DOMContentLoaded', () => {
    // Attach to all existing like buttons
    document.querySelectorAll('.like-btn').forEach(btn => attachLikeHandler(btn));
  });

  function attachLikeHandler(btn) {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const reviewId = btn.dataset.reviewId;
      if (!reviewId) return;

      // optimistic UI: disable while request in flight
      btn.disabled = true;

      // If already liked, you may want to toggle/unlike - adjust endpoint accordingly
      const alreadyLiked = btn.classList.contains('liked');

      try {
        const res = await fetch(`/review/${encodeURIComponent(reviewId)}/like`, {
          method: 'POST',
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json"
            // If you use CSRF protection, include token header here, e.g.
            // "X-CSRFToken": window.CSRF_TOKEN
          },
          body: JSON.stringify({ toggle: true }) // server may ignore body; adjust to your API
        });

        const data = await res.json();

        if (!res.ok || data.status !== 'success') {
          // show message on failure
          alert(data.message || 'Could not update like. Please try again.');
        } else {
          // update UI using server response
          const likes = data.likes;
          const liked = !!data.liked; // true if now liked

          // set button state and count
          btn.classList.toggle('liked', liked);
          btn.setAttribute('aria-pressed', liked ? 'true' : 'false');
          const countSpan = btn.querySelector('.like-count');
          if (countSpan) countSpan.textContent = String(likes);
        }
      } catch (err) {
        console.error(err);
        alert('Network error â€” could not send like.');
      } finally {
        btn.disabled = false;
      }
    });
  }

</script>
</div>

{% endblock %}
